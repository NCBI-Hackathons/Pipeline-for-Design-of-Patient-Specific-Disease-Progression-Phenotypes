```{r}
# NCBI Women Led Hackathon 2019
  # Script Written By: Hampton Leonard + Mary Makarious
  # Team Members: Ruth Chia, Sara Bandres-Ciga, Monica Diez
  # Last Updated: 08.05.2019

# Download the necessary packages if not already in environment 
if (!require(tidyverse)) install.packages('tidyverse')
if (!require(data.table)) install.packages('data.table')
if (!require(dplyr)) install.packages('dplyr')
if (!require(ggplot2)) install.packages('ggplot2')
if (!require(lme4)) install.packages('lme4')
if (!require(RNOmni)) install.packages('RNOmni')
```


```{r}
# Load the necessary packages 
library(tidyverse)
library(data.table)
library(dplyr)
library(ggplot2)
library(RNOmni)
library(lme4)

# Read in the dataset
tbl <- read.table("ppmi_hackathon_data.txt", header = T)

```


```{r}
# Scale everything to be able to be fed into LMM 
### to do - automatically scale all provided covariates

tbl_scaled <- tbl

tbl_scaled$TSTART <- scale(tbl_scaled$TSTART, center = F)
tbl_scaled$YEARSEDUC <- scale(tbl_scaled$YEARSEDUC, center = F)
tbl_scaled$AAO <- scale(tbl_scaled$AAO, center = F)


# Put scaled data into model
### to do - automatically put in correct phenotype of choice and covariates
### to do - stepwise selection of covariates for best model
  ## TODO: Add LDOPA and AGONIST data as covariates 
updrs3_slope <- lmer(UPDRS3_scaled ~ FEMALE + YEARSEDUC + AAO + DOPA + AGONIST + (TSTART|ID), tbl_scaled, REML = T)

summary(updrs3_slope)

# Get patient-specific slopes 
raneffect_updrs3 <- as.data.frame(ranef(updrs3_slope)$ID)
raneffect_updrs3$`(Intercept)` <- NULL
raneffect_updrs3$ID <- rownames(raneffect_updrs3)
  # plot(density(raneffect_updrs3$TSTART))

### Should we normalize?
  # Attempt with and without normalization and plot AUC plots
  # See which is more biologically relevant?

### to do - output metrics of model fit, maybe AUC plots etc
```

```{r}

## ggplot-style Density Plot 
slope_density_plot <- ggplot(raneffect_updrs3, aes(x=TSTART)) +
  geom_density(color="darkblue", fill="lightblue", alpha=0.4) + 
  theme_bw() +
  ggtitle("Density of Patient Slopes") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  labs(x = "Slopes of Patients",
       y = "Density") 

ggsave("Desnity_PatientSlopes.png", slope_density_plot, width = 5, height = 3.5, units = "in")
  

# output patient slopes
## to do - make output go to location specified by user

write.table(raneffect_updrs3, "patient_slopes.txt",  sep = "\t", append = F, row.names = F, quote = F, col.names = T)
```


